library(plyr)
library(dplyr)
library(data.table)
library(ggplot2)
library(reshape2)

#renaming result names
#plot distributions to check they are right
#make sure two teams for each game

Games <- fread("data/espn_games.csv")

Drives <- read.csv("data/espn_drives.csv") %>%
  mutate(gametime = as.POSIXct(paste("2014-01-01 00:", gametime, sep=""), tz="UTC")) %>%
  inner_join(Games)

#before remapping results
p <- Drives %>%
  group_by(result) %>% 
  summarise(n = n()) %>%
  ungroup %>%
  arrange(-n) %>%
  mutate(cum.n = cumsum(n)) %>%
  head(30) %>%
  ggplot(aes(x=reorder(result, n), y=n)) +
  geom_bar(stat="identity") +
  xlab("Drive Result") +
  ylab("Count") +
  coord_flip()
p
ggsave("figures/results_before_renaming.png", p, height=6, width=6)

mapping <- list("TD" = "Touchdown",
                "Rushing TD" = "Touchdown",
                "Passing TD" = "Touchdown",
                "RUSH Touchdown" = "Touchdown",
                "PASSRECEPTION Touchdown" = "Touchdown",
                "Field Goal" = "Field Goal Attempt",
                "Made FG" = "Field Goal Attempt",
                "Field Goal Good" = "Field Goal Attempt",
                "Missed FG" = "Field Goal Attempt",
                "Missed Field Goal" = "Field Goal Attempt",
                "Blocked FG" = "Field Goal Attempt",
                "FIELDGOAL Made field goal" = "Field Goal Attempt",
                "FIELDGOAL" = "Field Goal Attempt",
                "blocked Kick" = "Field Goal Attempt",
                "Turnover on Downs" = "Downs",
                "Pass Complete" = "Downs",
                "Pass Completion" = "Downs",
                "Incomplete" = "Downs",
                "Incomplete Pass" = "Downs",
                "Fumble Recovery (Own)" = "Downs",
                "Sack" = "Downs", 
                "Rush" = "Downs",
                "Pass" = "Downs",
                "Poss. on downs" = "Downs",
                "RUSH" = "Downs",
                "Blocked Punt, Downs" = "Downs",
                "Interception TD" = "Interception",
                "Intercepted Pass" = "Interception",
                "Pass Interception" = "Interception",
                "Fumble Recovery (Opponent)" = "Fumble",
                "Fumble Ret. TD" = "Fumble",
                "Fumble TD" = "Fumble",
                "Blocked Punt" = "Punt",
                "PUNT" = "Punt",
                "End of 1st Half" = "End of Half",
                "Fumble, Safety" = "Safety"
)

Drives <- Drives %>%
  mutate(res = mapvalues(result, names(mapping), unlist(mapping)))

#results after renaming
p <- Drives %>%
  group_by(res) %>%
  summarise(n = n()) %>%
  ungroup %>%
  arrange(-n) %>%
  mutate(cum.n = cumsum(n)) %>%
  head(30) %>%
  ggplot(aes(x = reorder(res, n), y=n)) +
  geom_bar(stat="identity") +
  xlab("Drive Result") +
  ylab("Count") +
  coord_flip()
p
ggsave("figures/results_after_renaming.png", p, height=6, width=6)

#check result by year/week to see if data looks consistent over time
normal.results <- c("Punt", "Touchdown", "Field Goal Attempt", "Interception", "Downs", "Fumble", "End of Half", "End of Game", "Safety")

p <- Drives %>%
  filter(res %in% normal.results) %>%
  group_by(year, week) %>%
  summarise(num_games = length(unique(game_id))) %>%
  ggplot(aes(x=week, y = num_games)) +
  facet_grid(. ~ year, scales="free_y") +
  ylab("Number of Games") +
  geom_line()
p
ggsave("figures/num_games_year_week.png", p, height=12, width=12)

p <- Drives %>%
  filter(res %in% normal.results) %>%
  group_by(year, week) %>%
  summarise(num_drives = n()) %>%
  ggplot(aes(x=week, y=num_drives)) +
  facet_grid(. ~ year, scales="free_y") +
  ylab("Number of Drives") +
  geom_line()
p
ggsave("figures/num_drives_year_week.png", p, height=12, width=12)

#ones with only one team/opponent
Drives %>%
  group_by(game_id) %>%
  summarise(n.teams = length(unique(team)),
            n.opps = length(unique(opponent))) %>%
  filter(n.opps != 2 | n.teams != 2) %>%
  head(20)

#one with small/large number drives
p <- Drives %>%
  filter(res %in% normal.results) %>%
  group_by(game_id) %>%
  summarise(num_drives = n()) %>%
  ggplot(aes(x=num_drives)) +
  geom_histogram(binwidth=1)
p

ggsave("figures/num_drives_by_game_before.png", p, height=6, width=6)

Drives <- Drives %>%
  group_by(game_id) %>%
  mutate(num_drives = n()) %>%
  filter(num_drives > 13, num_drives < 40) %>%
  select(-num_drives) %>%
  ungroup

p <- Drives %>%
  filter(res %in% normal.results) %>%
  group_by(game_id) %>%
  summarise(num_drives = n()) %>%
  ggplot(aes(x=num_drives)) +
  geom_histogram(binwidth=1)
p

ggsave("figures/num_drives_by_game_before.png", p, height=6, width=6)

Drives <- Drives %>%
  group_by(game_id) %>%
  mutate(num_drives= n()) %>%
  filter(num_drives > 13, num_drives < 40) %>%
  select(-num_drives) %>%
  ungroup

p <- Drives %>%
  filter(res %in% normal.results) %>%
  group_by(game_id) %>%
  summarise(num_drives = n()) %>%
  filter(num_drives > 13, num_drives < 40) %>%
  ggplot(aes(x=num_drives)) +
  geom_histogram(binwidth=1)
p

ggsave("figures/num_drives_by_game_after.png", p, height=6, width=6)


